<h1>Поиск запчастей</h1>
<br />

<%= form_tag(searches_path(:anchor => "jump"), :method => :get) do %>
  Каталожный номер * <br />
  <%= text_field_tag :catalog_number, params[:catalog_number], :id => "catalog-number" %> <br /><br />
  Производитель</a> <br />
  <%= text_field_tag :manufacturer, params[:manufacturer], :id => "manufacturer" %> <br /><br />
  <%= check_box_tag :replacements, "1", params[:replacements].to_i > 0 ? true : false %> Замены и аналоги <br /><br /><br />
  <%= submit_tag "Искать" %>
<% end %>

<% if @parsed_json["result_prices"].count > 0 %>

  <br />


  <table id="result-prices" class="zebra-striped">
    <thead>
      <tr>
        <th style="width: 80px">  <a href="#">Произв.</a> </th>
        <th style="width: 80px"> <a href="#">Кат.&nbsp;ном.</a> </th>
        <th> <a href="#">Название</a> </th>
        <th style="width: 60px">  <a href="#">Нал.</a> </th>
        <th style="width: 50px">  <a href="#">От</a> </th>
        <th style="width: 50px">  <a href="#">До</a>  </th>
        <th style="width: 50px">  <a href="#">Расп.</a>  </th>
        <th style="width: 50px">  <a href="#">Цена</a> </th>
      </tr>
    </thead>
    <tbody>
      <% @parsed_json["result_prices"].each do |result_price| %>
        <tr class="<%= result_price["css_class"]%>">
          <td> <%= manufacturer = result_price["manufacturer"] %> </td>
          <td> <%= link_to catalog_number = result_price["catalog_number"],  search_searches_path(catalog_number, manufacturer, '1', :anchor => "jump") %> </td>
          <td> <%= title = truncate(("#{result_price["title"].to_s} #{result_price["title_en"].to_s}").mb_chars.gsub(/([^ ]{15})/, '\1 '), :length => ( session[:screen_width].to_i > 1024 ) ? 60 : 40) %> </td>
          <td> <%= count_decorator(result_price["count"]) %></td>
          <td> <%= days_decorator(result_price['job_import_job_delivery_days_declared']) %></td>
          <td> <%= days_decorator(result_price["job_import_job_delivery_days_average"]) %></td>
          <td> <%= country = result_price["job_import_job_country_short"] %></td>
          <td>
            <span style="visibility: hidden; display:none"><%= income_cost = cost_decorator(income_cost = result_price["income_cost"] * (result_price["supplier_title"] == "emex" ? 1.07 : 1.08)) %></span>
            <%= form_for(:wish, :remote => true, :format => :json, :url => wishes_path, :method => :post, :html => {:style=>"margin: 0"}) do |f| %>
              <%= f.hidden_field :cost, :value => income_cost %>
              <%= f.hidden_field :catalog_number, :value => catalog_number %>
              <%= f.hidden_field :manufacturer, :value => manufacturer %>
              <%= f.hidden_field :title, :value => title %>
              <%= f.hidden_field :count, :value => result_price["count"] %>
              <%= f.hidden_field :declared, :value => result_price['job_import_job_delivery_days_declared'] %>
              <%= f.hidden_field :average, :value => result_price["job_import_job_delivery_days_average"] %>
              <%= f.hidden_field :country, :value => country %>
              <%= f.submit income_cost, :class => "btn primary buy-button", :style=>"width: 90px" %>
            <% end %>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>

  <br />

  <%= image_tag "spare_parts.png", :style => "z-index: 11; position: absolute; display: none", :id => "wishes-logo" %>
<% else %>
  <% unless params.key? :skip %>
    <% if params[:catalog_number].blank? %>
      <h3>Вы не указали искомый каталожный номер</h3>
    <% else %>
      <h3>Ничего не найдено <%= (catalog_number = params[:catalog_number]).present? ? "по каталожному номеру #{catalog_number}" : "" %> <%= (manufacturer = params[:manufacturer]).present? ? "и производителю #{manufacturer}" : ""%> <%= params[:replacements].present? ? "с учетом замен." : "без учета замен."  %> <br />
      <%= "Повторить поиск #{ link_to 'с учетом замен', search_searches_path(params[:catalog_number], params[:manufacturer], '1', :anchor => 'jump') } <br />".html_safe if (params[:replacements].to_i != 1) %>
      <%= "Повторить поиск #{ link_to 'без указания производителя', search_searches_path(params[:catalog_number], "", params[:replacements], :anchor => 'jump') } <br />".html_safe if params[:manufacturer].present? %></h3>
    <% end %>
  <% end %>
<% end %>