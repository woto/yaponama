<h1>Поиск запчастей</h1>

<%= form_tag(searches_path(:anchor => "jump"), :method => :get) do %>
  <div class="inputs">

    <div class="clearfix string optional">
      <label class="string optional">
        <a class="catalog-number-link" href="#" data-controls-modal="catalog-number-modal">Каталожный номер</a>
      </label>
      <div class="input">
        <%= text_field_tag :catalog_number, params[:catalog_number], :id => "catalog-number" %> <div id="clear-catalog-number" class='icons icons-sprite icons-delete'></div>
        <span class="help-block">Например: 42305−48010</span>
      </div>
    </div>
    

    <div class="clearfix string optional">
      <label class="string optional">
        <a class="catalog-number-link" href="#" data-controls-modal="catalog-number-modal">Производитель</a>
      </label>
      <div class="input">
        <%= text_field_tag :manufacturer, params[:manufacturer], :id => "manufacturer" %> <div id="clear-manufacturer" class='icons icons-sprite icons-delete'></div>
        <span class="help-block">Например: Toyota</span>        
      </div>
    </div>


    <div class="clearfix string optional">
      <label class="string optional">
        <a class="replacements-link" href="#" data-controls-modal="replacements-modal">Замены и аналоги</a>
      </label>
      <div class="input" style="margin-top: 6px">
        <%= check_box_tag :replacements, "1", params[:replacements].to_i > 0 ? true : false %> <br />
      </div>
    </div>


    <%= hidden_field_tag :rnd, rand() %>

    <div class="actions">
      <%= submit_tag "Искать", :class => "primary btn", :disable_with => "Пожалуйста ожидайте..." %>&nbsp;&nbsp;
      <% if user_search_histories.limit(3).size > 0 %>
        <% user_search_histories.limit(3).each do |ush| %>
          <%= link_to(ush.catalog_number + (ush.manufacturer? ?  " - " + ush.manufacturer : ""), search_searches_path(ush.catalog_number, ush.manufacturer, :anchor => "jump")) + ", " %>
        <% end %>
        <%= link_to "вся история поиска...", search_histories_path %>
      <% end %>
    </div>
  </div>
<% end %>

<% if @parsed_json["result_prices"].count > 0 %>
  <br />

  <p><span class="label notice">Подсказка</span> Используйте сортировку по нескольким полям зажав клавишу Shift и щелкая мышью по заголовку таблицы. Например нажмите на заголовке Производитель, зажмите Shift и щелкните по заголовку Цена. А так же вы можете уточнить замену по конкретной детали указав в поиске производителя, для этого введите название производителя самостоятельно либо просто  щелкните по каталожному номеру в списке результатов<span id="jump">.</span> <em>[fast: 0-1000, show: 0/1]</em></p>

  <br />

  <table id="result-prices" class="zebra-striped">
    <thead>
      <tr>
        <th style="width: 80px">  Произв. </th>
        <th style="width: 80px"> Кат.&nbsp;ном. </th>
        <th> Название </th>
        <th style="width: 60px">  Нал. </th>
        <th style="width: 50px">  От </th>
        <th style="width: 50px">  До  </th>
        <th style="width: 50px">  Расп.  </th>
        <th style="width: 50px">  Цена </th>
      </tr>
    </thead>
    <tbody>
      <% @parsed_json["result_prices"].each do |result_price| %>
        <tr class="<%= result_price["css_class"]%>">
          <td> <%= manufacturer = result_price["manufacturer"] %> </td>
          <td> <%= link_to catalog_number = result_price["catalog_number"],  search_searches_path(catalog_number, manufacturer, '1', :anchor => "jump") %> </td>
          <td> <%= title = truncate(("#{result_price["title"].to_s} #{result_price["title_en"].to_s}").mb_chars.gsub(/([^ ]{25})/, '\1 '), :length => ( session[:screen_width].to_i > 1024 ) ? 60 : 40) %> </td>
          <td> <%= count_decorator(result_price["count"]) %></td>
          <td> <%= days_decorator(result_price['job_import_job_delivery_days_declared']) %></td>
          <td> <%= days_decorator(result_price["job_import_job_delivery_days_average"]) %></td>
          <td> <%= country = result_price["job_import_job_country_short"] %></td>
          <td>
            <span style="visibility: hidden; display:none"><%= income_cost = cost_decorator(income_cost = result_price["income_cost"] * (result_price["supplier_title"] == "emex" ? 1.07 : 1.08)) %></span>
            <%= form_for(:wish, :remote => true, :format => :json, :url => wishes_path, :method => :post, :html => {:style=>"margin: 0"}) do |f| %>
              <%= f.hidden_field :cost, :value => income_cost %>
              <%= f.hidden_field :catalog_number, :value => catalog_number %>
              <%= f.hidden_field :manufacturer, :value => manufacturer %>
              <%= f.hidden_field :title, :value => title %>
              <%= f.hidden_field :count, :value => result_price["count"] %>
              <%= f.hidden_field :declared, :value => result_price['job_import_job_delivery_days_declared'] %>
              <%= f.hidden_field :average, :value => result_price["job_import_job_delivery_days_average"] %>
              <%= f.hidden_field :country, :value => country %>
              <%= f.submit income_cost, :class => "btn primary buy-button", :style=>"width: 90px" %>
            <% end %>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>

  <div class="pagination pager" id="pager" style="height: 60px">
    <ul id="pager-list">
      <li class="prev"><a href="#">← Пред. </a></li>
      <li class="next"><a href="#">След. →</a></li>
    </ul>

    <select class="pagesize" style="display: none">
      <!-- Не забыть, что это в 2-х местах -->
      <option selected="selected"  value="10">10</option>
      <option value="20">20</option>
      <option value="30">30</option>
      <option  value="40">40</option>
    </select>

    <input type="text" class="pagedisplay" style="display: none" />
  </div>

  <br />
  <br />
  <br />

  <%= image_tag "spare_parts.png", :style => "z-index: 11; position: absolute; display: none", :id => "wishes-logo" %>
<% else %>
  <% unless params.key? :skip %>
    <% if params[:catalog_number].blank? %>
      <h3>Вы не указали искомый каталожный номер</h3>
    <% else %>
      <h3>Ничего не найдено <%= (catalog_number = params[:catalog_number]).present? ? "по каталожному номеру #{catalog_number}" : "" %> <%= (manufacturer = params[:manufacturer]).present? ? "и производителю #{manufacturer}" : ""%> <%= params[:replacements].present? ? "с учетом замен." : "без учета замен."  %> <br />
      <%= "Повторить поиск #{ link_to 'с учетом замен', search_searches_path(params[:catalog_number], params[:manufacturer], '1', :anchor => 'jump') } <br />".html_safe if (params[:replacements].to_i != 1) %>
      <%= "Повторить поиск #{ link_to 'без указания производителя', search_searches_path(params[:catalog_number], "", params[:replacements], :anchor => 'jump') } <br />".html_safe if params[:manufacturer].present? %></h3>
    <% end %>
  <% end %>
<% end %>

<!-- The Modal Dialog  -->
<div id="catalog-number-modal" class="modal hide fade">
  <div class="modal-header">
    <h3>Каталожный номер</h3>
   <a href="#" class="close">&times;</a>
  </div>
  <div class="modal-body">
    <div style="overflow: hidden">
      <p>Тут рассказываем что такое каталожный номер, показываем картинки, говорим о важности указания производителя. </p>
    </div>
  </div>
  <div class="modal-footer">
   <a href="#" id="catalog-number-close" class="btn primary">Ок</a>
  </div>
</div>

<!-- The Modal Dialog  -->
<div id="replacements-modal" class="modal hide fade">
  <div class="modal-header">
    <h3>Замены и аналоги</h3>
   <a href="#" class="close">&times;</a>
  </div>
  <div class="modal-body">
    <div style="overflow: hidden">
      <p>Тут рассказываем что такое замены, аналоги, новый каталожный номер и т.д. </p>
    </div>
  </div>
  <div class="modal-footer">
   <a href="#" id="replacements-close" class="btn primary">Ок</a>
  </div>
</div>